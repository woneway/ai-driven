---
description: 闭环验证规则。每次任务完成后必须执行 /verify，确保质量门禁通过并自动记忆。
globs: "*"
---

# 闭环验证规则

## 核心理念

**闭环 = 完成任务 + 验证通过 + 自动记忆**

每次任务完成后必须执行 `/verify`，这是不可跳过的一步。

## /verify 命令

### 触发条件

- 任何功能开发完成后
- 任何 bug 修复完成后
- 任何优化完成后

### 执行流程

```
1. 检查所有质量门禁
2. 如果有项未通过 → 提示修复
3. 如果全部通过 → 自动记忆
4. 生成完成报告
```

### 验证清单

| # | 检查项 | 说明 |
|---|--------|------|
| 1 | proposal.md 完整 | 目标、约束、成功标准 |
| 2 | design.md 完整 | 方案选型、架构图、API |
| 3 | 测试存在 | TDD 方式，先写测试 |
| 4 | 测试通过 | 80%+ 覆盖率 |
| 5 | 代码审查通过 | /code-review 结果 |
| 6 | E2E 通过 | /e2e 结果 |
| 7 | lint 通过 | 无警告 |
| 8 | 记忆已添加 | 自动触发 |

## 自动记忆机制

当所有检查通过后，`/verify` 自动执行：

```python
# 自动记忆
memory = AiDrivenMemory(workspace_name)
memory.add(f"""
任务完成: {task_name}

技术方案: {design_summary}
遇到问题: {problems_solved}
解决方案: {solutions}

后续注意: {follow_ups}
""")
```

### 记忆内容

- 任务名称
- 使用的技术方案
- 遇到的问题及解决方案
- 后续注意事项

## 违反规则

如果 AI 未执行 `/verify` 就结束任务，视为**流程不完整**。

人类可以要求：
- "请执行 /verify 完成闭环"
- "先验证再结束"

## 整合开发流程

```
/sdd → 设计
  ↓
/plan → 计划
  ↓
/tdd → 实现
  ↓
/code-review → 审查
  ↓
/e2e → 测试
  ↓
/verify → 验证 + 记忆 ← 必须执行
```

## 检查点

- [ ] 每个任务完成后执行 /verify
- [ ] 所有检查项通过
- [ ] 记忆已自动添加
- [ ] 生成完成报告