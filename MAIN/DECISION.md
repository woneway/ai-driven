# Main Agent 决策逻辑

## 概述

本文档定义 Main Agent 如何分析需求并做出决策。

## 需求分类

### 按类型分类

| 类型 | 标识词 | 示例 |
|------|-------|------|
| 新功能 | "做"、"开发"、"添加" | "做一个锦标赛模式" |
| Bug | "修复"、"bug"、"错误" | "修复新建档案后数据没清空" |
| 优化 | "优化"、"提升"、"性能" | "优化排行榜查询性能" |
| 调研 | "调研"、"分析"、"了解" | "调研 WebSocket 连接管理" |
| 技术债 | "清理"、"重构"、"整理" | "清理 SwiftLint 警告" |

### 按复杂度分类

| 复杂度 | 判断标准 | 处理方式 |
|--------|---------|---------|
| **小** | < 2 小时，单文件改动 | 直接执行，跳过 formal 流程 |
| **中** | 2 小时 - 1 天，多文件改动 | 快速计划 + 审查 |
| **大** | > 1 天，跨模块改动 | 完整流程 |

## 决策流程

```
┌─────────────────────────────────────────────────────────────┐
│                    接收需求                                  │
│                 "帮我做一个锦标赛功能"                       │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    需求分类                                  │
│                 类型：新功能                                  │
│                 复杂度：大                                   │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    调度决策                                  │
│                                                             │
│  小需求 → 直接调度 Executor                                 │
│  中需求 → 调度 Planner → Executor → Reviewer                │
│  大需求 → Planner → Executor → Reviewer → QA              │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    执行                                      │
│                 按顺序执行子 Agent                           │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    结果汇总                                  │
│                 输出完成报告 + 更新记忆                      │
└─────────────────────────────────────────────────────────────┘
```

## 跳过规则

### Bug 修复

```
可跳过：Planner（跳过 formal 计划）
必须：Executor + Reviewer
```

### 调研

```
可跳过：Executor、QA
必须：Researcher
```

### 小优化

```
可跳过：Planner、QA
必须：Executor + Reviewer
```

## 子 Agent 调度

### Planner

负责：分析需求、制定计划

**何时调用**：
- 中等以上复杂度
- 需要明确计划的任务

**输入**：用户需求

**输出**：执行计划

### Executor

负责：代码实现

**何时调用**：
- 任何需要写代码的任务

**输入**：任务描述

**输出**：代码变更 + 测试结果

### Reviewer

负责：代码审查

**何时调用**：
- Executor 完成代码后

**输入**：代码变更

**输出**：审查报告

### Researcher

负责：调研分析

**何时调用**：
- 用户要求调研
- 需要了解某个技术

**输入**：调研主题

**输出**：调研报告

### QA

负责：测试验证

**何时调用**：
- 大需求完成前
- 用户要求测试

**输入**：功能描述 + 代码

**输出**：测试报告

---

## 版本

- **Version**: 1.0.0
- **Updated**: 2026-02-14
