## Context

当前 ai-driven 框架存在三个核心问题：

1. **工作区配置无效**：框架脚本只读取 ai-driven 根目录的 `.workspace.env`，工作区自己的配置文件从未被读取
2. **同步机制风险**：`sync-space.sh` 直接覆盖用户文件，没有备份机制
3. **路径推导脆弱**：依赖目录层级而非配置文件，降低了可移植性

这些问题影响了框架的可用性和健壮性。

## Goals / Non-Goals

**Goals:**
- 实现工作区级别配置读取和覆盖机制
- 改进同步机制，避免覆盖用户修改
- 强化路径推导，减少对目录层级的依赖

**Non-Goals:**
- 不改变框架的整体架构
- 不添加新的功能特性
- 不修改 OpenSpec 集成逻辑

## Decisions

### 决策 1：工作区配置读取机制

**选择**：在 `common.sh` 中添加工作区 `.workspace.env` 读取逻辑

**理由**：
- 最小改动原则，不影响现有逻辑
- 与现有配置加载流程一致
- 用户可以在工作区覆盖全局配置

**替代方案考虑**：
- 独立配置文件：需要额外维护，成本高
- 环境变量：依赖用户手动设置，不够透明

### 决策 2：同步机制改进

**选择**：备份+diff 机制，而非直接覆盖

**理由**：
- 保留用户修改历史
- 便于冲突解决
- 符合 git 思维

**替代方案考虑**：
- 强制覆盖：会丢失用户修改
- 手动合并：增加复杂度

### 决策 3：路径推导强化

**选择**：优先使用环境变量/配置文件，明确失败时的错误信息

**理由**：
- 环境变量是最可靠的配置方式
- 明确错误信息便于调试
- 保持向后兼容

**替代方案考虑**：
- 纯配置文件：需要维护额外的配置文件
- 纯目录推导：已经尝试过，不够可靠

## Risks / Trade-offs

| 风险 | 级别 | 缓解措施 |
|------|------|----------|
| 配置覆盖导致冲突 | 中 | 明确配置优先级：环境变量 > 工作区 .workspace.env > 全局 .workspace.env |
| 同步脚本复杂化 | 低 | 保持脚本简洁，核心逻辑不变 |
| 现有工作区不兼容 | 低 | 向后兼容，不改变已有行为 |

## Migration Plan

1. 修改 `common.sh` 添加工作区配置读取
2. 修改 `sync-space.sh` 添加备份逻辑
3. 修改 `init-space.sh` 改进 OpenSpec 检查
4. 更新文档说明配置优先级
5. 验证修复结果
